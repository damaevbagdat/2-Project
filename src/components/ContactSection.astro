---
// src/components/ContactSection.astro
import '../styles/global.css';
import { t } from '../i18n/index';

export interface Props { lang?: string }
const { lang = 'ru' } = Astro.props;
---

<section class="contact-section" id="contact">
  <div class="container">
    <h2 class="section-title">{t('sections.contactTitle', lang)}</h2>
    <div class="contact-container">
      <div class="contact-info">
        <h2 class="contact-subtitle">{t('contact.subtitle', lang)}</h2>
        <p class="contact-desc">{t('contact.desc', lang)}</p>
        <div class="social-links">
          <a href="https://wa.me/77479022293?text=Ð—Ð´Ñ€Ð°Ð²ÑÑ‚Ð²ÑƒÐ¹Ñ‚Ðµ!%20ÐŸÐ¸ÑˆÑƒ%20Ñ%20ÑÐ°Ð¹Ñ‚Ð°%20gose.kz.%20" class="social-link" target="_blank" rel="noopener noreferrer">
            <span class="social-icon">ðŸ“±</span>
            <div>
              <strong>WhatsApp</strong>
              <p>{t('contact.whatsappDesc', lang)}</p>
            </div>
          </a>
          <a href="tel:+77479022293" class="social-link">
            <span class="social-icon">ðŸ“ž</span>
            <div>
              <strong>8 747 902 22 93</strong>
              <p>{t('contact.phoneDesc', lang)}</p>
            </div>
          </a>
          <a href="tel:+77086899067" class="social-link">
            <span class="social-icon">ðŸ“ž</span>
            <div>
              <strong>8 708 689 90 67</strong>
              <p>{t('contact.phoneDesc', lang)}</p>
            </div>
          </a>
        </div>
      </div>
      <div class="contact-form-wrapper">
        <h3 class="form-title">{t('contact.formTitle', lang)}</h3>
        <form class="contact-form" id="contact-form">
          <div class="form-group">
            <label>{t('contact.formLabelName', lang)}</label>
            <input type="text" name="name" required />
          </div>
          <div class="form-group">
            <label>{t('contact.formLabelPhone', lang)}</label>
            <input type="tel" name="phone" required />
          </div>
          <div class="form-group">
            <label>{t('contact.formLabelMessage', lang)}</label>
            <textarea name="message" required></textarea>
          </div>
          <!-- Honeypot field - hidden from users, visible to bots -->
          <input type="text" name="website" value="" style="position: absolute; left: -9999px; width: 1px; height: 1px;" tabindex="-1" autocomplete="off" aria-hidden="true" />
          <!-- Cloudflare Turnstile invisible CAPTCHA -->
          <div class="cf-turnstile" data-sitekey="YOUR_SITE_KEY_HERE" data-theme="light" data-size="invisible"></div>
          <button type="submit" class="cta-button form-submit">{t('contact.formSubmit', lang)}</button>
        </form>
      </div>
    </div>
  </div>
</section>

<!-- Load Cloudflare Turnstile script -->
<script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>

<style>
.contact-section {
  padding: 8rem 5%;
  background: linear-gradient(180deg, var(--secondary), var(--primary));
}

.section-title {
  text-align: center;
  font-size: 3rem;
  margin-bottom: 4rem;
  color: var(--accent);
}

.contact-container {
  max-width: 1200px;
  margin: 0 auto;
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 4rem;
}

.contact-info h2 {
  font-size: 2.5rem;
  color: var(--accent);
  margin-bottom: 2rem;
}

.contact-info p {
  color: var(--text-muted);
  margin-bottom: 3rem;
  font-size: 1.1rem;
}

.social-links {
  display: flex;
  flex-direction: column;
  gap: 1.5rem;
}

.social-link {
  display: flex;
  align-items: center;
  gap: 1.5rem;
  padding: 1.5rem;
  background: var(--bg-card);
  backdrop-filter: blur(10px);
  border-radius: 15px;
  text-decoration: none;
  color: var(--text);
  border: 1px solid rgba(201, 169, 97, 0.2);
  transition: all 0.3s ease;
}

.social-link:hover {
  background: rgba(201, 169, 97, 0.1);
  border-color: var(--accent);
  transform: translateX(10px);
}

.social-icon {
  font-size: 2rem;
  width: 50px;
  text-align: center;
  flex-shrink: 0;
}

.social-link strong {
  display: block;
  color: var(--text);
  margin-bottom: 0.25rem;
}

.social-link p {
  margin: 0;
  color: var(--text-muted);
  font-size: 0.9rem;
}

.contact-form-wrapper {
  background: var(--bg-card);
  backdrop-filter: blur(10px);
  padding: 3rem;
  border-radius: 20px;
  border: 1px solid rgba(201, 169, 97, 0.2);
}

.form-title {
  color: var(--accent);
  margin-bottom: 1.5rem;
  font-size: 1.8rem;
}

.contact-form {
  display: flex;
  flex-direction: column;
  gap: 1.5rem;
}

.form-group {
  display: flex;
  flex-direction: column;
}

.form-group label {
  margin-bottom: 0.5rem;
  color: var(--accent-light);
  font-weight: 500;
}

.form-group input,
.form-group textarea {
  width: 100%;
  padding: 1rem;
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(201, 169, 97, 0.2);
  border-radius: 10px;
  color: var(--text);
  font-size: 1rem;
  transition: all 0.3s ease;
  font-family: inherit;
}

.form-group input:focus,
.form-group textarea:focus {
  outline: none;
  border-color: var(--accent);
  background: rgba(255, 255, 255, 0.08);
}

.form-group textarea {
  resize: vertical;
  min-height: 150px;
}

.form-submit {
  width: 100%;
  background: var(--gradient-accent);
  color: var(--primary);
  padding: 1.2rem 3rem;
  border: none;
  border-radius: 50px;
  font-size: 1.1rem;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.4s ease;
  box-shadow: 0 10px 30px rgba(201, 169, 97, 0.3);
}

.form-submit:hover {
  transform: translateY(-3px);
  box-shadow: 0 15px 40px rgba(201, 169, 97, 0.5);
}

@media (max-width: 768px) {
  .contact-section {
    padding: 4rem 1rem;
  }

  .section-title {
    font-size: 2rem;
    margin-bottom: 2rem;
  }

  .contact-container {
    grid-template-columns: 1fr;
    gap: 2rem;
  }

  .contact-info h2 {
    font-size: 2rem;
  }

  .contact-form-wrapper {
    padding: 2rem;
  }

  .form-title {
    font-size: 1.5rem;
  }
}
</style>

<script>
  const form = document.getElementById('contact-form') as HTMLFormElement;
  if (form) {
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const lang = document.documentElement.lang || 'ru';
      const formData = new FormData(form);

      const name = formData.get('name');
      const phone = formData.get('phone');
      const message = formData.get('message');
      const honeypot = formData.get('website');

      // Bot protection: Honeypot check
      if (honeypot) {
        console.log('Bot detected - honeypot field filled');
        return; // Silently reject bot submissions
      }

      // Rate limiting: Check last submission time
      const lastSubmit = localStorage.getItem('lastContactSubmit');
      const now = Date.now();
      if (lastSubmit && now - parseInt(lastSubmit) < 60000) {
        const waitTime = Math.ceil((60000 - (now - parseInt(lastSubmit))) / 1000);
        const messages = {
          ru: `ÐŸÐ¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð°, Ð¿Ð¾Ð´Ð¾Ð¶Ð´Ð¸Ñ‚Ðµ ${waitTime} ÑÐµÐºÑƒÐ½Ð´ Ð¿ÐµÑ€ÐµÐ´ ÑÐ»ÐµÐ´ÑƒÑŽÑ‰ÐµÐ¹ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐ¾Ð¹.`,
          kz: `ÐšÐµÐ»ÐµÑÑ– Ð¶Ñ–Ð±ÐµÑ€Ñƒ Ð°Ð»Ð´Ñ‹Ð½Ð´Ð° ${waitTime} ÑÐµÐºÑƒÐ½Ð´ ÐºÒ¯Ñ‚Ñ–Ò£Ñ–Ð·.`,
          en: `Please wait ${waitTime} seconds before submitting again.`
        };
        alert(messages[lang] || messages.ru);
        return;
      }

      const button = form.querySelector('button[type="submit"]') as HTMLButtonElement;
      const originalText = button.textContent;
      button.disabled = true;
      button.textContent = lang === 'ru' ? 'ÐžÑ‚Ð¿Ñ€Ð°Ð²ÐºÐ°...' : lang === 'kz' ? 'Ð–Ñ–Ð±ÐµÑ€Ñ–Ð»ÑƒÐ´Ðµ...' : 'Sending...';

      try {
        // Get Turnstile token (if configured)
        let turnstileToken = '';
        const turnstileElement = form.querySelector('.cf-turnstile');
        if (turnstileElement && typeof window.turnstile !== 'undefined') {
          try {
            turnstileToken = window.turnstile.getResponse(turnstileElement);
          } catch (e) {
            console.log('Turnstile not configured or failed', e);
          }
        }

        // Send through backend API (bot token is now securely hidden on server)
        const response = await fetch('/api/gose-contact', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            name,
            phone,
            message,
            honeypot, // Server will check this
            turnstileToken, // Turnstile CAPTCHA token (when configured)
          })
        });

        const result = await response.json();

        const successMessages = {
          ru: 'Ð¡Ð¿Ð°ÑÐ¸Ð±Ð¾! Ð’Ð°ÑˆÐµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¾.',
          kz: 'Ð Ð°Ñ…Ð¼ÐµÑ‚! Ð¥Ð°Ð±Ð°Ñ€Ð»Ð°Ð¼Ð°Ò£Ñ‹Ð· Ð¶Ñ–Ð±ÐµÑ€Ñ–Ð»Ð´Ñ–.',
          en: 'Thank you! Your message has been sent.'
        };

        const errorMessages = {
          ru: 'ÐžÑˆÐ¸Ð±ÐºÐ° Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐ¸. ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ Ð¿Ð¾Ð·Ð¶Ðµ.',
          kz: 'Ð–Ñ–Ð±ÐµÑ€Ñƒ Ò›Ð°Ñ‚ÐµÑÑ–. ÐšÐµÐ¹Ñ–Ð½Ñ–Ñ€ÐµÐº Ò›Ð°Ð¹Ñ‚Ð°Ð»Ð°Ð¿ ÐºÓ©Ñ€Ñ–Ò£Ñ–Ð·.',
          en: 'Sending error. Please try again later.'
        };

        if (response.ok && result.success) {
          // Save submission time for rate limiting
          localStorage.setItem('lastContactSubmit', now.toString());
          alert(successMessages[lang] || successMessages.ru);
          form.reset();
        } else {
          // Handle specific error messages from server
          const errorMsg = result.message || errorMessages[lang] || errorMessages.ru;
          alert(errorMsg);
        }
      } catch (error) {
        alert('ÐžÑˆÐ¸Ð±ÐºÐ° Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐ¸. ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ Ð¿Ð¾Ð·Ð¶Ðµ.');
      } finally {
        button.disabled = false;
        button.textContent = originalText;
      }
    });
  }
</script>
